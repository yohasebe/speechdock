name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-26
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.0'

      - name: Get version
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Install create-dmg and fileicon
        run: brew install create-dmg fileicon

      - name: Import signing certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Decode certificate
          echo -n "$CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Allow codesign to access the keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Build app
        run: |
          chmod +x scripts/build.sh
          ./scripts/build.sh

      - name: Create DMG
        run: |
          chmod +x scripts/create-dmg.sh
          ./scripts/create-dmg.sh

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
          APP_PASSWORD: ${{ secrets.APP_PASSWORD }}
        run: |
          chmod +x scripts/notarize.sh
          ./scripts/notarize.sh

      - name: Download Sparkle
        run: |
          curl -L -o /tmp/Sparkle.tar.xz https://github.com/sparkle-project/Sparkle/releases/download/2.6.0/Sparkle-2.6.0.tar.xz
          mkdir -p /tmp/Sparkle
          tar -xf /tmp/Sparkle.tar.xz -C /tmp/Sparkle

      - name: Sign DMG for Sparkle and update appcast
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # Get DMG filename and info
          DMG_FILE=$(ls SpeechDock-*.dmg)
          DMG_SIZE=$(stat -f%z "$DMG_FILE")
          VERSION=$(cat VERSION)
          BUILD_NUMBER=$(grep -A1 'CFBundleVersion' Resources/Info.plist | grep '<string>' | sed 's/.*<string>\(.*\)<\/string>.*/\1/')
          PUB_DATE=$(date -R)

          # Create temporary file with private key
          echo "$SPARKLE_PRIVATE_KEY" > /tmp/sparkle_key.txt

          # Sign the DMG - extract just the signature value (without attribute name)
          RAW_SIGNATURE=$(/tmp/Sparkle/bin/sign_update "$DMG_FILE" -f /tmp/sparkle_key.txt | head -1)
          # Extract the base64 signature from: sparkle:edSignature="..." length="..."
          SIGNATURE=$(echo "$RAW_SIGNATURE" | sed -n 's/.*sparkle:edSignature="\([^"]*\)".*/\1/p')

          # Clean up key file
          rm /tmp/sparkle_key.txt

          # Update appcast.xml
          cat > appcast.xml << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" xmlns:dc="http://purl.org/dc/elements/1.1/">
              <channel>
                  <title>SpeechDock Updates</title>
                  <link>https://github.com/yohasebe/speechdock</link>
                  <description>Most recent changes with links to updates.</description>
                  <language>en</language>
                  <item>
                      <title>Version ${VERSION}</title>
                      <pubDate>${PUB_DATE}</pubDate>
                      <sparkle:version>${BUILD_NUMBER}</sparkle:version>
                      <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>
                      <sparkle:minimumSystemVersion>14.0</sparkle:minimumSystemVersion>
                      <enclosure
                          url="https://github.com/yohasebe/speechdock/releases/download/v${VERSION}/${DMG_FILE}"
                          sparkle:edSignature="${SIGNATURE}"
                          length="${DMG_SIZE}"
                          type="application/octet-stream"/>
                  </item>
              </channel>
          </rss>
          EOF

          echo "Signed DMG: $DMG_FILE"
          echo "Signature: $SIGNATURE"
          echo "Size: $DMG_SIZE bytes"

      - name: Commit and push appcast.xml
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add appcast.xml
          git commit -m "Update appcast.xml for v$(cat VERSION)"
          git push origin HEAD:main

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: SpeechDock-*.dmg
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew Cask
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          DMG_FILE=$(ls SpeechDock-*.dmg)
          VERSION=$(cat VERSION)
          SHA256=$(shasum -a 256 "$DMG_FILE" | awk '{print $1}')

          # Clone homebrew-speechdock repo
          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/yohasebe/homebrew-speechdock.git" /tmp/homebrew-speechdock
          cd /tmp/homebrew-speechdock

          # Update cask file
          cat > Casks/speechdock.rb << CASKEOF
          cask "speechdock" do
            version "${VERSION}"
            sha256 "${SHA256}"

            url "https://github.com/yohasebe/speechdock/releases/download/v#{version}/SpeechDock-#{version}.dmg"
            name "SpeechDock"
            desc "Menu bar STT/TTS app for macOS with multiple provider support"
            homepage "https://github.com/yohasebe/speechdock"

            depends_on macos: ">= :sonoma"

            app "SpeechDock.app"

            zap trash: [
              "~/Library/Preferences/com.speechdock.app.plist",
              "~/Library/Application Support/SpeechDock",
            ]
          end
          CASKEOF

          # Remove leading whitespace from heredoc
          sed -i '' 's/^          //' Casks/speechdock.rb

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/speechdock.rb
          git commit -m "Update SpeechDock to v${VERSION}"
          git push

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true

